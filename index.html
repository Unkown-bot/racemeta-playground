<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RaceMeta – F1 Strategy Agent</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: radial-gradient(circle at 30% 20%, #1d1f27, #0b0c11);
      min-height: 100vh;
      color: white;
    }
    .card {
      background: rgba(255, 255, 255, 0.06);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 18px;
      padding: 24px;
    }
  </style>
</head>

<body class="text-white">

  <!-- HEADER -->
  <header class="w-full flex justify-between items-center px-6 py-5 max-w-6xl mx-auto">
    <div class="flex items-center gap-4">
      <div class="w-10 h-10 rounded-xl bg-red-500 flex items-center justify-center font-bold text-xl">R</div>
      <div>
        <div class="text-xl font-semibold">RaceMeta</div>
        <div class="text-xs text-red-300 tracking-widest">F1 STRATEGY AGENT</div>
      </div>
    </div>

    <div id="headerControls" class="flex gap-4">
      <button id="simpleMode" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20">Simple</button>
      <button id="proMode" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700">Pro</button>
      <button id="newAnalysis" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20">New analysis</button>
    </div>
  </header>

  <!-- ERROR BANNER -->
  <div id="errorBanner" class="hidden w-full text-center py-3 bg-red-700 text-white">
    Could not reach backend — showing demo output.
  </div>

  <!-- ASK SECTION -->
  <section id="askSection" class="pt-12">
    <div class="max-w-3xl mx-auto px-4">

      <div class="text-center mb-10">
        <h2 class="text-4xl font-semibold">Ask about any F1 strategy call.</h2>
        <p class="text-slate-300 max-w-2xl mx-auto">
          Mention the driver, race and lap. RaceMeta will automatically use OpenF1 data.
        </p>
      </div>

      <div class="card space-y-4">
        <label class="text-sm text-slate-300">Your question</label>
        <textarea
          id="questionInput"
          class="w-full h-32 bg-black/40 p-4 rounded-lg border border-white/10 focus:outline-none"
          placeholder="e.g. “Should Leclerc have pitted on lap 16 in Bahrain?”"
        ></textarea>

        <button
          id="analyzeBtn"
          type="button"
          class="w-full h-12 bg-gradient-to-r from-orange-500 to-red-500 rounded-xl text-white font-semibold flex items-center justify-center gap-2 disabled:opacity-60"
        >
          <span id="analyzeSpinner" class="hidden w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
          <span id="analyzeBtnLabel">Analyze strategy</span>
        </button>
      </div>

      <div class="mt-10 space-y-3">
        <button class="w-full bg-white/5 px-4 py-3 rounded-lg text-left">Was pitting Leclerc on lap 16 in Bahrain actually optimal?</button>
        <button class="w-full bg-white/5 px-4 py-3 rounded-lg text-left">Should Verstappen have stayed out under the Safety Car in Austria?</button>
        <button class="w-full bg-white/5 px-4 py-3 rounded-lg text-left">Did Norris box too early covering the undercut in Silverstone?</button>
      </div>
    </div>
  </section>

  <!-- SIMPLE SECTION -->
  <section id="simpleSection" class="hidden pt-12">
    <div class="max-w-3xl mx-auto px-4 space-y-8">

      <div id="simpleBreadcrumbs" class="text-slate-300 text-sm"></div>

      <div id="simpleVerdictCard" class="card"></div>

      <div id="simpleRecommended" class="card"></div>

      <button
        id="simpleToPro"
        type="button"
        class="w-full py-3 rounded-lg bg-white/10 hover:bg-white/20"
      >
        View detailed analysis →
      </button>
    </div>
  </section>

  <!-- PRO SECTION -->
  <section id="proSection" class="hidden pt-12">
    <div class="max-w-5xl mx-auto px-4 space-y-8">

      <div id="proBreadcrumbs" class="text-slate-300 text-sm"></div>

      <div id="proVerdictCard" class="card"></div>

      <h2 class="text-xl font-semibold">Performance metrics</h2>
      <div id="metricsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>

      <h2 class="text-xl font-semibold">Detailed analysis</h2>
      <div id="proReasoning" class="space-y-4"></div>

      <h2 class="text-xl font-semibold">Recommended strategy</h2>
      <div id="proRecommended" class="card"></div>

    </div>
  </section>

  <script>
    /* ---------- BACKEND URL ---------- */
    const BACKEND_URL = "https://racemeta-backend-production.up.railway.app/analyze_latest";

    /* ---------- SAFE ELEMENT LOOKUP ---------- */
    function safeGet(id) {
      const el = document.getElementById(id);
      if (!el) console.warn("Missing element:", id);
      return el;
    }

    const askSection = safeGet("askSection");
    const simpleSection = safeGet("simpleSection");
    const proSection = safeGet("proSection");
    const errorBanner = safeGet("errorBanner");

    const analyzeBtn = safeGet("analyzeBtn");
    const analyzeBtnLabel = safeGet("analyzeBtnLabel");
    const analyzeSpinner = safeGet("analyzeSpinner");
    const questionInput = safeGet("questionInput");

    const simpleVerdictCard = safeGet("simpleVerdictCard");
    const simpleBreadcrumbs = safeGet("simpleBreadcrumbs");
    const simpleRecommended = safeGet("simpleRecommended");
    const simpleToPro = safeGet("simpleToPro");

    const proVerdictCard = safeGet("proVerdictCard");
    const proBreadcrumbs = safeGet("proBreadcrumbs");
    const metricsGrid = safeGet("metricsGrid");
    const proReasoning = safeGet("proReasoning");
    const proRecommended = safeGet("proRecommended");

    const simpleMode = safeGet("simpleMode");
    const proMode = safeGet("proMode");
    const newAnalysis = safeGet("newAnalysis");


    /* ---------- UI HELPERS ---------- */
    function show(section) {
      askSection.classList.add("hidden");
      simpleSection.classList.add("hidden");
      proSection.classList.add("hidden");
      section.classList.remove("hidden");
    }

    function setLoading(state) {
      if (state) {
        analyzeSpinner.classList.remove("hidden");
        analyzeBtnLabel.textContent = "Analyzing…";
        analyzeBtn.disabled = true;
      } else {
        analyzeSpinner.classList.add("hidden");
        analyzeBtnLabel.textContent = "Analyze strategy";
        analyzeBtn.disabled = false;
      }
    }

    /* ---------- RENDER FUNCTIONS ---------- */
    function renderSimple(json) {
      simpleBreadcrumbs.textContent = json.race_context.label;
      simpleVerdictCard.innerHTML = `
        <div class="text-xl font-semibold">${json.summary} 
          <span class="text-sm text-slate-300 ml-2">(${json.confidence}% confidence)</span>
        </div>
        <p class="mt-2 text-slate-300">${json.verdict}</p>

        <div class="mt-6 card w-40">
          <div class="text-sm text-slate-300">Tyre life</div>
          <div class="text-xl font-semibold">${json.metrics?.tyre_life?.value || "-"}</div>
        </div>
      `;
      simpleRecommended.innerHTML = `
        <div class="font-semibold mb-1">Recommended alternative</div>
        <p class="text-slate-300">${json.recommended_strategy}</p>
      `;
    }

    function renderPro(json) {
      proBreadcrumbs.textContent = json.race_context.label;

      proVerdictCard.innerHTML = `
        <div class="text-xl font-semibold">${json.summary}
          <span class="text-sm text-slate-300 ml-2">${json.confidence}% confidence</span>
        </div>
        <p class="mt-2 text-slate-300 whitespace-pre-line">${json.verdict}</p>
      `;

      metricsGrid.innerHTML = "";
      const metrics = json.metrics || {};

      const metricNames = [
        "tyre_life",
        "traffic_cost",
        "track_position",
        "pace_delta",
        "undercut_window",
        "final_position"
      ];

      metricNames.forEach(key => {
        const m = metrics[key];
        metricsGrid.innerHTML += `
          <div class="card">
            <div class="text-sm text-slate-300">${m?.label || key.replace("_"," ")}</div>
            <div class="text-xl font-semibold">${m?.value || "-"}</div>
            <p class="text-slate-400 text-sm mt-2">${m?.description || "Metric not computed yet."}</p>
          </div>
        `;
      });

      proReasoning.innerHTML = "";
      json.reasoning.forEach((point, i) => {
        proReasoning.innerHTML += `
          <div class="card flex gap-3">
            <div class="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center text-sm">${i+1}</div>
            <p>${point}</p>
          </div>
        `;
      });

      proRecommended.innerHTML = `
        <p class="text-lg">${json.recommended_strategy}</p>
      `;
    }

    /* ---------- BUTTON HANDLERS ---------- */
    analyzeBtn.onclick = async () => {
      const q = questionInput.value.trim();
      if (!q) return;
      setLoading(true);

      try {
        const res = await fetch(BACKEND_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question: q })
        });

        if (!res.ok) throw new Error("Backend error");
        const json = await res.json();

        renderSimple(json);
        renderPro(json);
        show(simpleSection);
        errorBanner.classList.add("hidden");

      } catch (e) {
        console.error(e);
        errorBanner.classList.remove("hidden");
      }

      setLoading(false);
    };

    simpleToPro.onclick = () => show(proSection);
    simpleMode.onclick = () => show(simpleSection);
    proMode.onclick = () => show(proSection);
    newAnalysis.onclick = () => show(askSection);

  </script>

</body>
</html>
