<!doctype html>
<html lang="en" data-theme="pro">
  <head>
    <meta charset="utf-8" />
    <title>RaceMeta ‚Äì F1 Strategy Console</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Theme variables -->
    <style>
      :root {
        --bg: #f6f7fb;
        --card-bg: #ffffff;
        --card-subtle: #f3f4f6;
        --border-subtle: #e5e7eb;
        --text-main: #0f172a;
        --text-muted: #6b7280;
        --accent: #2563eb;
        --chip-bg: #e5edff;
      }

      html[data-theme="f1"] {
        --bg: #050910;
        --card-bg: #070b14;
        --card-subtle: #020617;
        --border-subtle: #111827;
        --text-main: #e5e7eb;
        --text-muted: #9ca3af;
        --accent: #22d3ee;
        --chip-bg: #022c3a;
      }

      body {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #0b1020 0, transparent 45%),
          var(--bg);
        color: var(--text-main);
      }

      .nice-scroll::-webkit-scrollbar {
        width: 6px;
      }
      .nice-scroll::-webkit-scrollbar-track {
        background: transparent;
      }
      .nice-scroll::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.7);
        border-radius: 999px;
      }
    </style>
  </head>

  <body class="min-h-screen">
    <div class="min-h-screen flex flex-col">
      <!-- HEADER -->
      <header
        class="border-b border-[var(--border-subtle)]/70 backdrop-blur-sm bg-[var(--bg)]/80"
      >
        <div
          class="max-w-5xl mx-auto px-4 md:px-8 py-4 flex items-center justify-between gap-4"
        >
          <div class="flex items-center gap-2">
            <div
              class="h-7 w-7 rounded-xl bg-[var(--accent)]/10 border border-[var(--accent)]/40 flex items-center justify-center"
            >
              <span
                class="text-[10px] font-semibold tracking-[0.16em] uppercase text-[var(--accent)]"
                >RM</span
              >
            </div>
            <div>
              <div
                class="text-sm font-semibold tracking-[0.16em] uppercase text-[var(--text-muted)]"
              >
                RaceMeta
              </div>
              <div class="text-xs text-[var(--text-muted)]">
                F1 Strategy Console
              </div>
            </div>
          </div>

          <nav class="flex items-center gap-4 text-sm">
            <a
              href="#how-it-works"
              class="text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors"
              >How it works</a
            >
            <a
              href="https://github.com/unkown-bot/racemeta-playground"
              target="_blank"
              class="inline-flex items-center gap-1 px-2.5 py-1.5 rounded-full text-xs border border-[var(--border-subtle)] hover:border-[var(--accent)]/70 hover:text-[var(--accent)] transition-colors"
            >
              <span>GitHub</span>
              <span aria-hidden="true">‚Üó</span>
            </a>
          </nav>
        </div>
      </header>

      <!-- MAIN -->
      <main
        class="flex-1 max-w-5xl mx-auto w-full px-4 md:px-8 pt-4 md:pt-6 pb-28"
      >
        <!-- Top row -->
        <div
          class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4 md:mb-6"
        >
          <div>
            <h1 class="text-xl md:text-2xl font-semibold tracking-tight">
              Judge any F1 race strategy like a pit wall engineer.
            </h1>
            <p class="mt-1 text-sm text-[var(--text-muted)] max-w-xl">
              Describe a race scenario &mdash; track, tyres, laps, gaps. RaceMeta
              breaks down whether the call made sense.
            </p>
          </div>

          <!-- Theme toggle -->
          <div class="flex items-center gap-3 self-start md:self-auto">
            <span class="text-xs text-[var(--text-muted)] uppercase tracking">
              Mode
            </span>
            <div
              class="inline-flex items-center rounded-full border border-[var(--border-subtle)] bg-[var(--card-subtle)] px-1 py-1 text-xs"
            >
              <button
                type="button"
                data-theme-btn="pro"
                class="px-3 py-1 rounded-full font-medium transition-all text-[var(--text-muted)] data-[active=true]:bg-[var(--card-bg)] data-[active=true]:text-[var(--text-main)] data-[active=true]:shadow-sm"
              >
                Pro
              </button>
              <button
                type="button"
                data-theme-btn="f1"
                class="px-3 py-1 rounded-full font-medium transition-all text-[var(--text-muted)] data-[active=true]:bg-[var(--card-bg)] data-[active=true]:text-[var(--accent)] data-[active=true]:shadow-sm"
              >
                F1
              </button>
            </div>
          </div>
        </div>

        <!-- GRID -->
        <div class="grid gap-6 md:gap-8 md:grid-cols-[minmax(0,2.1fr),minmax(260px,1fr)]">
          <!-- CHAT COLUMN -->
          <section
            id="chat-column"
            class="rounded-2xl border border-[var(--border-subtle)]/80 bg-[var(--card-bg)]/95 shadow-sm flex flex-col max-h-[72vh]"
          >
            <div
              id="chat-messages"
              class="flex-1 overflow-y-auto nice-scroll px-4 md:px-6 py-4 md:py-5 space-y-4"
            >
              <!-- Empty state -->
              <div
                id="empty-state"
                class="rounded-xl border border-dashed border-[var(--border-subtle)] bg-[var(--card-subtle)]/60 px-4 py-4 md:px-5 md:py-5"
              >
                <p class="text-xs font-medium text-[var(--text-muted)] mb-2">
                  Try a scenario like:
                </p>
                <ul class="space-y-1.5 text-sm text-[var(--text-main)]">
                  <li>
                    ‚Ä¢ Bahrain &mdash; Leclerc starts on mediums, pits lap 16 for
                    hards with a 2.8s gap. Smart undercut or too early?
                  </li>
                  <li>
                    ‚Ä¢ Generic dry race &mdash; Norris on softs with high deg,
                    rivals pit lap 12 to mediums. Should McLaren cover on lap 13?
                  </li>
                  <li>
                    ‚Ä¢ Australia &mdash; Safety Car on lap 20, Perez stays out on
                    used mediums while others box for hards. Good call?
                  </li>
                </ul>
              </div>
            </div>

            <!-- Loading bar -->
            <div
              id="loading-bar"
              class="h-0.5 w-0 bg-[var(--accent)] transition-all duration-300"
            ></div>
          </section>

          <!-- ASIDE -->
          <aside class="space-y-4" id="how-it-works">
            <div
              class="rounded-2xl border border-[var(--border-subtle)]/80 bg-[var(--card-bg)]/90 shadow-sm p-4 md:p-5"
            >
              <h2 class="text-xs font-semibold uppercase tracking text-[var(--text-muted)] mb-2">
                How to ask
              </h2>
              <p class="text-sm text-[var(--text-muted)] mb-3">
                Include track, tyres, laps, gaps and race context. The more
                detail, the sharper the verdict.
              </p>
              <div class="space-y-2">
                <button
                  type="button"
                  class="w-full text-left text-xs md:text-sm px-3 py-2 rounded-xl border border-[var(--border-subtle)] bg-[var(--card-subtle)]/80 hover:border-[var(--accent)]/60 hover:bg-[var(--card-subtle)] transition-colors"
                  data-example
                >
                  ‚ÄúBahrain, Ferrari starts Leclerc on mediums, boxes lap 16 for
                  hards with 2.8s gap to Russell. High deg. Was that pit timing
                  correct?‚Äù
                </button>
                <button
                  type="button"
                  class="w-full text-left text-xs md:text-sm px-3 py-2 rounded-xl border border-[var(--border-subtle)] bg-[var(--card-subtle)]/80 hover:border-[var(--accent)]/60 hover:bg-[var(--card-subtle)] transition-colors"
                  data-example
                >
                  ‚ÄúDry race, Norris on softs, rivals pit lap 12 to mediums,
                  McLaren covers lap 13. Undercut strong. Was pitting then right
                  or should they have extended?‚Äù
                </button>
              </div>
            </div>

            <div
              class="rounded-2xl border border-[var(--border-subtle)]/80 bg-[var(--card-bg)]/90 shadow-sm p-4 md:p-5"
            >
              <h2 class="text-xs font-semibold uppercase tracking text-[var(--text-muted)] mb-2">
                Quick legend
              </h2>
              <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-xs">
                <div>
                  <dt class="font-medium text-[var(--text-main)]">Compounds</dt>
                  <dd class="text-[var(--text-muted)] mt-1">
                    üî¥ Soft &mdash; peak grip, high deg<br />
                    üü° Medium &mdash; balanced<br />
                    ‚ö™ Hard &mdash; durable, slow warm-up
                  </dd>
                </div>
                <div>
                  <dt class="font-medium text-[var(--text-main)]">
                    Strategy flags
                  </dt>
                  <dd class="text-[var(--text-muted)] mt-1">
                    ‚¨á Undercut &mdash; pit earlier for clean laps<br />
                    ‚¨Ü Overcut &mdash; stay out on pace<br />
                    ‚ö† SC/VSC &mdash; cheap stop window
                  </dd>
                </div>
              </dl>
            </div>

            <div
              class="rounded-2xl border border-[var(--border-subtle)]/80 bg-[var(--card-bg)]/90 shadow-sm p-4 md:p-5"
            >
              <h2 class="text-xs font-semibold uppercase tracking text-[var(--text-muted)] mb-2">
                What RaceMeta considers
              </h2>
              <ul class="space-y-1.5 text-xs text-[var(--text-muted)]">
                <li>‚Ä¢ Tyre behaviour and degradation pattern</li>
                <li>‚Ä¢ Track overtaking difficulty &amp; pit loss</li>
                <li>‚Ä¢ Gaps to cars ahead / behind at pit window</li>
                <li>‚Ä¢ Risk vs reward for alternate strategies</li>
              </ul>
            </div>
          </aside>
        </div>
      </main>

      <!-- INPUT BAR -->
      <footer
        class="fixed inset-x-0 bottom-0 border-t border-[var(--border-subtle)] bg-[var(--bg)]/95 backdrop-blur-sm"
      >
        <div class="max-w-5xl mx-auto px-4 md:px-8 py-3">
          <form id="chat-form" class="flex items-end gap-3" autocomplete="off">
            <div class="flex-1">
              <label for="prompt" class="sr-only">Race scenario</label>
              <textarea
                id="prompt"
                rows="1"
                class="w-full resize-none rounded-2xl border border-[var(--border-subtle)] bg-[var(--card-bg)] px-3.5 py-2.5 text-sm text-[var(--text-main)] placeholder:text-[var(--text-muted)] focus:outline-none focus:ring-2 focus:ring-[var(--accent)]/70 focus:border-[var(--accent)]/60"
                placeholder="Describe a race scenario, including track, tyres, laps, gaps..."
              ></textarea>
            </div>
            <button
              type="submit"
              class="inline-flex items-center justify-center rounded-2xl px-4 py-2.5 text-sm font-medium bg-[var(--accent)] text-white shadow-sm hover:brightness-110 active:scale-[0.98] transition-transform disabled:opacity-60 disabled:cursor-not-allowed"
              id="send-btn"
            >
              Send
              <span class="ml-1.5" aria-hidden="true">‚Üó</span>
            </button>
          </form>
        </div>
      </footer>
    </div>

    <!-- JS -->
    <script>
      const BACKEND_URL =
        "https://racemeta-backend-production.up.railway.app/analyze_latest";

      // Theme toggle
      const themeButtons = document.querySelectorAll("[data-theme-btn]");
      const htmlEl = document.documentElement;

      function setTheme(theme) {
        htmlEl.setAttribute("data-theme", theme);
        themeButtons.forEach((btn) => {
          btn.dataset.active = btn.dataset.themeBtn === theme ? "true" : "false";
        });
      }

      themeButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          setTheme(btn.dataset.themeBtn);
        });
      });

      setTheme("pro");

      const chatForm = document.getElementById("chat-form");
      const promptInput = document.getElementById("prompt");
      const chatMessages = document.getElementById("chat-messages");
      const emptyState = document.getElementById("empty-state");
      const loadingBar = document.getElementById("loading-bar");

      function addMessage(role, content, isHtml = false) {
        if (emptyState) emptyState.style.display = "none";

        const wrapper = document.createElement("div");
        wrapper.className = "space-y-1";

        const chip = document.createElement("div");
        chip.className =
          "inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium bg-[var(--chip-bg)] text-[var(--text-muted)] uppercase tracking-[0.12em]";
        chip.textContent = role === "user" ? "You" : "RaceMeta";

        const card = document.createElement("div");
        card.className =
          "rounded-2xl border border-[var(--border-subtle)] bg-[var(--card-bg)] px-3.5 py-3 text-sm";
        if (role === "assistant") {
          card.className +=
            " border-l-4 border-l-[var(--accent)]/80 shadow-[0_0_0_1px_rgba(15,23,42,0.02)]";
        }

        if (isHtml) {
          card.innerHTML = content;
        } else {
          card.textContent = content;
        }

        wrapper.appendChild(chip);
        wrapper.appendChild(card);
        chatMessages.appendChild(wrapper);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function setLoading(isLoading) {
        if (isLoading) {
          loadingBar.style.width = "35%";
          loadingBar.style.opacity = "1";
        } else {
          loadingBar.style.width = "100%";
          setTimeout(() => {
            loadingBar.style.opacity = "0";
            loadingBar.style.width = "0";
          }, 200);
        }
      }

      // Example buttons fill textarea
      document.querySelectorAll("[data-example]").forEach((btn) => {
        btn.addEventListener("click", () => {
          promptInput.value = btn.textContent.trim().replace(/^‚Äú|‚Äù$/g, "");
          promptInput.focus();
        });
      });

      // Enter behaviour
      promptInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          chatForm.requestSubmit();
        }
      });

      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const prompt = promptInput.value.trim();
        if (!prompt) return;

        addMessage("user", prompt);
        promptInput.value = "";
        setLoading(true);

        try {
          const res = await fetch(BACKEND_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ question: prompt }),
          });

          if (!res.ok) {
            const html = `<p class="text-sm text-[var(--text-muted)]">Something went wrong talking to the backend (HTTP ${res.status}). Try again or tweak the question.</p>`;
            addMessage("assistant", html, true);
            return;
          }

          const data = await res.json();
          const verdict = data.verdict || "(No verdict returned.)";
          const context = data.context;

          let answerHtml = `
            <p class="mb-2 whitespace-pre-line">${verdict}</p>
          `;

          if (context) {
            answerHtml += `
              <details class="mt-3 text-xs text-[var(--text-muted)]">
                <summary class="cursor-pointer font-medium text-[var(--accent)]">
                  Show context block
                </summary>
                <pre class="mt-1 whitespace-pre-wrap rounded-lg border border-[var(--border-subtle)]/70 bg-[var(--card-subtle)]/70 p-2">${context}</pre>
              </details>
            `;
          }

          addMessage("assistant", answerHtml, true);
        } catch (err) {
          console.error(err);
          const html =
            '<p class="text-sm text-[var(--text-muted)]">Network error. Check your connection or whether the Railway backend is awake.</p>';
          addMessage("assistant", html, true);
        } finally {
          setLoading(false);
        }
      });
    </script>
  </body>
</html>
